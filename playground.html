<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPA Archives</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css"> 
    <link rel="stylesheet" href="map.css">

    <style>
        /* Sidebar e Tabs */
        .sidebar { display: flex; flex-direction: column; gap: 10px; max-height: 90vh; }
        
        .tab-buttons {
            display: flex;
            gap: 5px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .tab-btn {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            color: #aaa;
            padding: 8px;
            cursor: pointer;
            font-family: 'Rajdhani';
            font-weight: bold;
            flex: 1;
            transition: 0.3s;
        }

        .tab-btn.active {
            background: var(--neon-blue);
            color: #000;
            box-shadow: 0 0 10px var(--neon-blue);
        }

        /* Lista de Items (Top 10 / Wealth) */
        .list-container { flex: 1; overflow-y: auto; padding-right: 5px; }

        .rank-card {
            background: rgba(0,20,40,0.6);
            border-left: 3px solid var(--neon-blue);
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .rank-pos { font-size: 1.2em; font-weight: bold; width: 30px; color: #fff; }
        .rank-info { flex: 1; text-align: left; }
        .rank-name { font-weight: bold; color: var(--neon-blue); font-size: 1.1em; }
        .rank-val { font-family: monospace; color: #ffd700; }

        /* Snapshot do Mapa */
        .map-snapshot-container {
            position: relative;
            width: 100%;
            height: 500px; /* Ajusta conforme necessário */
            background: #051020;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            padding: 20px;
            overflow-y: auto;
            gap: 5px;
        }
        
        .snap-dot {
            width: 15px; height: 15px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.2s;
        }
        .snap-dot:hover { transform: scale(1.5); z-index: 10; border-color: #fff; }

        /* Ajustes Mobile */
        @media (max-width: 768px) {
            .dashboard-container { flex-direction: column; }
            .sidebar { max-height: 400px; }
        }
    </style>
</head>
<body>

    <nav class="top-nav">
        <div class="logo-section"><h1>CPA ARCHIVES</h1></div>
        <div class="nav-links">
            <a href="index.html">Live Map</a>
            <a href="#" class="active">Archives</a>
        </div>
    </nav>

    <div class="dashboard-container">
        
        <aside class="sidebar">
            <div style="margin-bottom:15px;">
                <label style="color:#aaa; font-size:0.8em;">SELECT ARCHIVE DATE</label>
                <select id="weekSelector" class="archive-selector" onchange="loadWeekData(this.value)" style="width:100%; margin-top:5px;">
                    <option>Loading History...</option>
                </select>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('top10')">TOP 10</button>
                <button class="tab-btn" onclick="switchTab('active')">FORCES</button>
                <button class="tab-btn" onclick="switchTab('wealth')">WEALTH</button>
            </div>

            <div id="sidebarContent" class="list-container">
                </div>
        </aside>

        <div class="map-wrapper">
            <div class="map-header">
                <span class="status-indicator">
                    <div class="status-dot"></div> 
                    ARCHIVED STATE: <span id="archiveLabel" style="color:#fff; margin-left:5px;">-</span>
                </span>
            </div>

            <div style="padding:20px;">
                <h3 style="color:var(--neon-blue);">TERRITORY SNAPSHOT</h3>
                <p style="color:#aaa; font-size:0.9em; margin-bottom:15px;">Visual representation of territory control at the time of archiving.</p>
                
                <div id="mapSnapshot" class="map-snapshot-container">
                    <div style="color:#666;">Select a date to load snapshot...</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        let historyData = [];
        let currentWeek = null;
        let currentTab = 'top10';

        // 1. Carregar History.json ao iniciar
        window.onload = async function() {
            try {
                // Tenta carregar history.json. Se não existir, usa array vazio para não crashar
                const response = await fetch('history.json');
                if (response.ok) {
                    historyData = await response.json();
                } else {
                    console.warn("history.json not found.");
                }

                const selector = document.getElementById('weekSelector');
                selector.innerHTML = "";

                if (historyData.length === 0) {
                    selector.innerHTML = "<option>No Archives Found</option>";
                    return;
                }

                // Preencher Dropdown
                historyData.forEach((week, index) => {
                    const opt = document.createElement('option');
                    opt.value = index;
                    opt.innerText = `${week.id} (${week.date})`;
                    selector.appendChild(opt);
                });

                // Carregar o primeiro (mais recente)
                loadWeekData(0);

            } catch (e) {
                console.error(e);
            }
        };

        // 2. Carregar Dados da Semana Selecionada
        function loadWeekData(index) {
            currentWeek = historyData[index];
            document.getElementById('archiveLabel').innerText = currentWeek.id;
            
            // Atualizar Sidebar (depende da tab ativa)
            renderSidebar();

            // Atualizar Mapa Snapshot
            renderMapSnapshot(currentWeek.map_snapshot);
        }

        // 3. Sistema de Tabs
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Atualizar Botões (Visual)
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            renderSidebar();
        }

        function renderSidebar() {
            const container = document.getElementById('sidebarContent');
            container.innerHTML = "";

            if (!currentWeek) return;

            let data = [];
            let type = "";

            if (currentTab === 'top10') {
                data = currentWeek.top_ten || [];
                type = "top10";
            } else if (currentTab === 'active') {
                data = currentWeek.active_forces || [];
                type = "active";
            } else if (currentTab === 'wealth') {
                data = currentWeek.wealth || [];
                type = "wealth";
            }

            if (data.length === 0) {
                container.innerHTML = "<div style='color:#666; text-align:center; margin-top:20px;'>No Data Available</div>";
                return;
            }

            data.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = "rank-card";
                
                let rank = index + 1;
                let valueHtml = "";

                // Lógica Específica por Tab
                if (type === 'top10') {
                    rank = item.rank; // Usa o rank manual
                    valueHtml = `<span class="rank-val" style="color:var(--neon-blue)">${item.points} PTS</span>`;
                } 
                else if (type === 'active') {
                    valueHtml = `<span class="rank-val">${item.servers} SERVERS</span>`;
                }
                else if (type === 'wealth') {
                    valueHtml = `<span class="rank-val" style="color:#ffd700">$${formatMoney(item.balance)}</span>`;
                }

                row.innerHTML = `
                    <div class="rank-pos">#${rank}</div>
                    <div class="rank-info">
                        <div class="rank-name">${item.name}</div>
                    </div>
                    ${valueHtml}
                `;
                container.appendChild(row);
            });
        }

        // 4. Renderizador do Snapshot do Mapa
        function renderMapSnapshot(snapshotData) {
            const container = document.getElementById('mapSnapshot');
            container.innerHTML = "";

            if (!snapshotData) return;

            // Ordenar alfabeticamente para ficar bonito no grid
            const territories = Object.keys(snapshotData).sort();

            territories.forEach(terrName => {
                const owner = snapshotData[terrName];
                
                const dot = document.createElement('div');
                dot.className = "snap-dot";
                dot.style.backgroundColor = getArmyColor(owner);
                dot.title = `${terrName}: ${owner}`; // Tooltip nativo
                
                container.appendChild(dot);
            });
        }

        // Funções Utilitárias
        function formatMoney(amount) {
            if (amount >= 1000000) return (amount / 1000000).toFixed(1) + 'M';
            if (amount >= 1000) return (amount / 1000).toFixed(1) + 'k';
            return amount;
        }

        function getArmyColor(name) {
            // Podes adicionar hardcode de cores populares aqui ou usar o hash generator
            const colors = {
                "Freeland": "#222",
                "None": "#111",
                "Templars": "#d6a600",
                "Elite Guardians": "#004400",
                "Water Vikings": "#0066ff",
                "Rebel Penguin Federation": "#000000",
                "Army of Club Penguin": "#006400",
                "Help Force": "#0000ff"
            };
            
            if (colors[name]) return colors[name];
            return stringToColor(name);
        }

        function stringToColor(str) {
            if (!str) return "#333";
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                let value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }
    </script>
</body>
</html>
