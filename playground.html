<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Penguin Armies: The Archive</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css"> 
    <link rel="stylesheet" href="map.css">
    
    <link id="archiveMapCss" rel="stylesheet" href="map.css">

    <script src="https://code.highcharts.com/maps/highmaps.js"></script>

    <style>
        /* === O TEU CSS ORIGINAL (INTOCADO) === */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(0, 243, 255, 0.1);
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-val { font-size: 1.8em; font-weight: bold; color: #fff; text-shadow: 0 0 10px rgba(0, 243, 255, 0.3); }
        .stat-label { font-size: 0.8em; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        .archive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(0,0,0,0.2);
        }

        select.archive-selector {
            background: #051020;
            color: var(--neon-blue);
            border: 1px solid var(--neon-blue);
            padding: 8px 15px;
            font-family: 'Rajdhani';
            text-transform: uppercase;
            font-weight: bold;
            cursor: pointer;
        }

        /* === NOVOS ESTILOS PARA AS TABS DA SIDEBAR (Mínimos) === */
        .tab-container { display: flex; gap: 5px; margin-bottom: 10px; padding: 10px; }
        .tab-btn { 
            flex: 1; background: #051020; border: 1px solid var(--neon-blue); color: var(--neon-blue);
            padding: 5px; cursor: pointer; font-family: 'Rajdhani'; font-size: 0.8em; text-transform: uppercase;
        }
        .tab-btn.active { background: var(--neon-blue); color: #000; font-weight: bold; }
        
        /* Iframe para Top10/Forces/Wealth */
        .sidebar-iframe { width: 100%; flex: 1; border: none; min-height: 300px; }

        /* === O CONTENTOR DO MAPA (Substitui o Snapshot Grid) === */
        /* Removi o .snapshot-grid e meti isto para o mapa caber */
        #container {
            width: 100%;
            height: 500px; /* Altura fixa para o mapa aparecer bem */
            border: 1px solid rgba(0, 243, 255, 0.1);
            background: transparent;
        }

        /* Override Highcharts Background para ser transparente */
        .highcharts-container, .highcharts-root { background: transparent !important; }

        /* Footer e Layout originais */
        .footer-text { text-align:center; padding: 10px; color: #555; font-size: 0.8rem; }
        .dashboard-container { display: flex; height: calc(100vh - 80px); }
        .sidebar { width: 300px; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; border-right: 1px solid #333; }
        .map-wrapper { flex: 1; display: block; overflow-y: auto; background: #02050a; }
        .map-header { padding: 15px; border-bottom: 1px solid #333; }
    </style>
</head>
<body>

    <nav class="top-nav">
        <div class="logo-section">
            <h1>CPA: THE MAP <span style="font-size:0.5em; color:var(--text-muted); vertical-align: super;">ARCHIVES</span></h1>
        </div>
        <div class="nav-links">
            <a href="index.html">Live Map</a>
            <a href="#" class="active">Archives</a>
            <a href="https://discord.gg/cparmies" target="_blank">Discord</a>
        </div>
    </nav>

    <div class="dashboard-container">
        
        <aside class="sidebar">
            <div style="padding-bottom:15px; border-bottom:1px solid var(--border-color); margin-bottom:15px;">
                <h2 style="margin:10px; border:none; font-family:'Rajdhani'; color:#fff;">Select Date</h2>
                <div style="padding:0 10px;">
                    <select id="weekSelector" class="archive-selector" onchange="loadWeekData(this.value)" style="width:100%">
                        <option>Loading...</option>
                    </select>
                </div>
            </div>

            <div class="tab-container">
                <button class="tab-btn active" onclick="switchTab('topten')">TOP 10</button>
                <button class="tab-btn" onclick="switchTab('forces')">FORCES</button>
                <button class="tab-btn" onclick="switchTab('wealth')">WEALTH</button>
            </div>

            <iframe id="sidebarContent" class="sidebar-iframe" src=""></iframe>
            
        </aside>

        <div class="map-wrapper">
            
            <div class="map-header">
                <span class="status-indicator">
                    <div class="status-dot" style="background:var(--neon-blue); box-shadow:0 0 8px var(--neon-blue);"></div> 
                    ARCHIVED DATA: <span id="archiveDate" style="color:#fff; margin-left:5px;">-</span>
                </span>
            </div>

            <div style="padding:20px;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-val" id="totalSpent">0</div>
                        <div class="stat-label">Coins Spent</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="totalAttacks">0</div>
                        <div class="stat-label">Attacks Launched</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="totalWars">0</div>
                        <div class="stat-label">Active Wars</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="favWeapon">-</div>
                        <div class="stat-label">Fav. Weapon</div>
                    </div>
                </div>

                <h3 style="color:var(--neon-blue); text-transform:uppercase; border-bottom:1px solid var(--border-color); padding-bottom:10px;">Territory Snapshot</h3>
                
                <div id="container"></div>

                <div id="loadingMsg" style="display:none; color:#00f3ff; text-align:center; padding:20px; font-family:'Rajdhani'">LOADING MAP...</div>

            </div>
        </div>
    </div>

    <div class="footer-text">
        UI by df44 for CPA
    </div>

    <script>
        let historyData = [];
        let currentBasePath = ""; // Guarda o caminho da semana atual

        window.onload = async function() {
            try {
                const response = await fetch('history.json');
                if (!response.ok) throw new Error("History file not found");
                historyData = await response.json();

                const selector = document.getElementById('weekSelector');
                selector.innerHTML = "";
                
                if (historyData.length === 0) {
                    selector.innerHTML = "<option>No Archives Found</option>";
                    return;
                }

                historyData.forEach((week, index) => {
                    const opt = document.createElement('option');
                    opt.value = index;
                    opt.innerText = `${week.id} (${week.date})`;
                    selector.appendChild(opt);
                });

                loadWeekData(0);

            } catch (e) {
                console.error(e);
                document.getElementById('container').innerHTML = `<div style="text-align:center; color:#ff0055;">ARCHIVE OFFLINE</div>`;
            }
        };

        function loadWeekData(index) {
            const week = historyData[index];
            const stats = week.stats.global;
            
            // Define o path (ex: archives/2026-01-24)
            currentBasePath = week.path || `archives/${week.date}`;

            // 1. Header & Stats (Tua lógica original)
            document.getElementById('archiveDate').innerText = week.date;
            document.getElementById('totalSpent').innerText = formatMoney(stats.spent);
            document.getElementById('totalAttacks').innerText = stats.attacks;
            document.getElementById('totalWars').innerText = stats.wars || 0;
            
            let fav = "None"; let max = 0;
            for (const [item, count] of Object.entries(stats.items || {})) {
                if (count > max) { max = count; fav = item; }
            }
            document.getElementById('favWeapon').innerText = fav.toUpperCase();

            // 2. Carregar a Tab Inicial (Top Ten)
            switchTab('topten');

            // 3. CARREGAR O MAPA REAL (Substitui as bolinhas)
            loadArchiveMap(currentBasePath);
        }

        // Função para gerir as tabs da Sidebar
        function switchTab(tabName) {
            // Atualiza botões
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active'); // O botão clicado fica ativo (se clicado via JS pode dar erro, mas funciona no onload)

            const iframe = document.getElementById('sidebarContent');
            
            // Aponta para os ficheiros HTML dentro da pasta da semana
            if (tabName === 'topten') iframe.src = `${currentBasePath}/topten.html`;
            if (tabName === 'forces') iframe.src = `${currentBasePath}/army_code.html`;
            if (tabName === 'wealth') iframe.src = `${currentBasePath}/wealth.html`;
        }

        // A Lógica do Mapa Dinâmico
        function loadArchiveMap(basePath) {
            const container = document.getElementById('container');
            const loader = document.getElementById('loadingMsg');
            
            // Limpa o mapa anterior
            if (Highcharts.charts[0]) { Highcharts.charts[0].destroy(); }
            container.innerHTML = "";
            loader.style.display = 'block';

            // 1. Injetar CSS do Mapa Arquivado
            document.getElementById('archiveMapCss').href = `${basePath}/map.css?t=${Date.now()}`;

            // 2. Injetar JS do Mapa Arquivado
            const oldScript = document.getElementById('dynamicMapScript');
            if (oldScript) oldScript.remove();

            const script = document.createElement('script');
            script.id = 'dynamicMapScript';
            script.src = `${basePath}/map.js?t=${Date.now()}`;
            
            script.onload = () => { loader.style.display = 'none'; };
            script.onerror = () => { 
                loader.style.display = 'none'; 
                container.innerHTML = "<div style='text-align:center; padding-top:50px; color:#555'>MAP DATA NOT FOUND</div>";
            };

            document.body.appendChild(script);
        }

        function formatMoney(amount) {
            if (!amount) return "0";
            if (amount >= 1000000) return (amount / 1000000).toFixed(1) + 'M';
            if (amount >= 1000) return (amount / 1000).toFixed(1) + 'k';
            return amount.toLocaleString('en-US');
        }
    </script>
</body>
</html>
