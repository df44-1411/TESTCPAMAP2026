<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CPA: THE ARCHIVE</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://code.highcharts.com/maps/highmaps.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="map.css"> <style>
        /* CSS DOS CARTÕES BONITOS (Baseado no teu army_code.py) */
        .army-card {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(20, 30, 50, 0.85); border: 1px solid rgba(255, 255, 255, 0.1);
            border-left-width: 5px; margin-bottom: 8px; padding: 12px 15px;
            border-radius: 4px; backdrop-filter: blur(4px); transition: 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); cursor: pointer;
        }
        .army-card:hover { transform: translateX(5px); background: rgba(40, 50, 80, 0.95); }
        .army-name { color: #e0e6ed; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .army-val { background: rgba(255,255,255,0.1); color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 0.85rem; }

        /* Estrutura */
        .dashboard-container { display: flex; height: calc(100vh - 60px); }
        .sidebar { width: 350px; background: rgba(5, 16, 32, 0.9); border-right: 1px solid var(--border-color); padding: 15px; display: flex; flex-direction: column; }
        .map-area { flex: 1; position: relative; background: #030a14; }
        #archiveMap { width: 100%; height: 100%; }

        .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 8px; background: #051020; border: 1px solid var(--neon-blue); color: var(--neon-blue); font-family: 'Rajdhani'; cursor: pointer; font-size: 0.7em; }
        .tab-btn.active { background: var(--neon-blue); color: #000; }
    </style>
</head>
<body>
    <nav class="top-nav">
        <h1>CPA ARCHIVES</h1>
        <div class="nav-links"><a href="index.html">Live Map</a></div>
    </nav>

    <div class="dashboard-container">
        <aside class="sidebar">
            <select id="weekSelector" class="archive-selector" onchange="loadWeek(this.value)" style="width:100%; margin-bottom:15px;"></select>
            
            <div class="tabs">
                <button class="tab-btn active" onclick="setTab('topten')">TOP 10</button>
                <button class="tab-btn" onclick="setTab('forces')">FORCES</button>
                <button class="tab-btn" onclick="setTab('wealth')">WEALTH</button>
            </div>

            <div id="leaderboardList" style="flex:1; overflow-y:auto;"></div>
        </aside>

        <main class="map-area">
            <div id="archiveMap"></div>
        </main>
    </div>

    <script>
        let historyData = [];
        let currentTab = 'topten';
        let chart;
        let baseMapData = []; // Guardará a estrutura id/path de id0, id1...

        // 1. Carregar estrutura base do mapa (map.js)
        async function init() {
            const resp = await fetch('map.js');
            const text = await resp.text();
            const match = text.match(/var mapData = (\[.*?\]);/s);
            baseMapData = JSON.parse(match[1]);

            const hResp = await fetch('history.json');
            historyData = await hResp.json();
            
            const sel = document.getElementById('weekSelector');
            historyData.forEach((w, i) => sel.innerHTML += `<option value="${i}">${w.id} (${w.date})</option>`);
            
            loadWeek(0);
        }

        function renderMap(snapshot) {
            // Unir a estrutura geográfica com os donos do arquivo
            const displayData = baseMapData.map(region => ({
                ...region,
                controller: snapshot[region.name] || "None"
            }));

            if (chart) chart.destroy();

            chart = Highcharts.mapChart('archiveMap', {
                chart: { backgroundColor: 'transparent' },
                title: { text: '' },
                series: [{
                    data: displayData,
                    mapData: displayData,
                    joinBy: 'id',
                    dataLabels: { enabled: true, color: '#fff', format: '{point.name}' }
                }],
                tooltip: {
                    formatter: function() { return `<b>${this.point.name}</b><br>Owner: ${this.point.controller}`; }
                }
            });
        }

        function renderLeaderboard(week) {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = "";
            let data = [];

            if (currentTab === 'topten') {
                data = week.leaderboard; // [{name, score}]
            } else if (currentTab === 'forces') {
                const counts = {};
                Object.values(week.map_snapshot).forEach(o => { if(o !== "None" && o !== "Freeland") counts[o] = (counts[o]||0)+1; });
                data = Object.entries(counts).map(([name, val]) => ({name, score: val})).sort((a,b) => b.score - a.score);
            }

            data.forEach((entry, i) => {
                list.innerHTML += `
                    <div class="army-card" style="border-left-color: #00f3ff">
                        <span class="army-name">#${i+1} ${entry.name}</span>
                        <span class="army-val">${entry.score}</span>
                    </div>`;
            });
        }

        function loadWeek(idx) {
            const week = historyData[idx];
            renderMap(week.map_snapshot);
            renderLeaderboard(week);
        }

        function setTab(t) {
            currentTab = t;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase().includes(t)));
            loadWeek(document.getElementById('weekSelector').value);
        }

        init();
    </script>
</body>
</html>
