<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Penguin Armies: The Archive</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css"> 
    <link rel="stylesheet" href="map.css">

    <style>
        /* Ajustes Espec√≠ficos para a P√°gina de Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(0, 243, 255, 0.1);
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-val { font-size: 1.8em; font-weight: bold; color: #fff; text-shadow: 0 0 10px rgba(0, 243, 255, 0.3); }
        .stat-label { font-size: 0.8em; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        .archive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(0,0,0,0.2);
        }

        select.archive-selector {
            background: #051020;
            color: var(--neon-blue);
            border: 1px solid var(--neon-blue);
            padding: 8px 15px;
            font-family: 'Rajdhani';
            text-transform: uppercase;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }

        /* Leaderboard / Tabs Styling */
        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }
        
        .tab-btn {
            flex: 1;
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--border-color);
            color: #888;
            padding: 5px;
            cursor: pointer;
            font-family: 'Rajdhani';
            font-weight: bold;
            font-size: 0.8rem;
            transition: 0.2s;
        }
        
        .tab-btn.active {
            background: var(--neon-blue);
            color: #000;
            border-color: var(--neon-blue);
        }

        .lb-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            align-items: center;
            font-size: 0.9em;
        }
        .lb-rank { color: var(--neon-blue); font-weight: bold; width: 25px; }
        .lb-name { flex: 1; font-weight: 600; color: #ddd; }
        .lb-val { font-family: monospace; letter-spacing: 1px; font-weight: bold; }
        
        .val-hidden { color: #ff0055; letter-spacing: 2px; font-size: 0.8em; }
        .val-points { color: #00ff9d; }
        .val-gold { color: #ffd700; }

        /* Map Snapshot Grid */
        .snapshot-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 20px;
            justify-content: center;
            overflow-y: auto;
            max-height: 500px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
        }
        
        .snap-dot {
            width: 14px;
            height: 14px;
            background: #222;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: help;
            transition: transform 0.1s;
        }
        .snap-dot:hover {
            transform: scale(1.5);
            border-color: #fff;
            z-index: 10;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <nav class="top-nav">
        <div class="logo-section">
            <h1>CPA: THE MAP <span style="font-size:0.5em; color:var(--text-muted); vertical-align: super;">ARCHIVES</span></h1>
        </div>
        <div class="nav-links">
            <a href="index.html">Live Map</a>
            <a href="#" class="active">Archives</a>
            <a href="https://discord.gg/cparmies" target="_blank">Discord</a>
        </div>
    </nav>

    <div class="dashboard-container">
        
        <aside class="sidebar">
            <div style="padding-bottom:15px; border-bottom:1px solid var(--border-color); margin-bottom:15px;">
                <h2 style="margin:0 0 10px 0; border:none; font-size:1em; color:#aaa;">SELECT ARCHIVE</h2>
                <select id="weekSelector" class="archive-selector" onchange="loadWeekData(this.value)">
                    <option>Loading History...</option>
                </select>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('top10')">TOP 10</button>
                <button class="tab-btn" onclick="switchTab('wealth')">WEALTH</button>
                <button class="tab-btn" onclick="switchTab('active')">FORCES</button>
            </div>

            <h2 id="lbTitle" style="font-size:1.1em; color:var(--neon-blue); border-bottom:1px solid var(--neon-blue); padding-bottom:5px;">Rankings</h2>
            
            <div id="leaderboardList" style="flex:1; overflow-y:auto; min-height: 300px;">
                </div>
            
            <div style="margin-top:20px; padding-top:10px; border-top:1px solid var(--border-color);">
                <div style="font-size:0.8em; color:var(--text-muted); text-transform:uppercase;">Weekly Warmonger</div>
                <div id="warmongerName" style="font-size:1.4em; font-weight:bold; color:#ff0055;">-</div>
                <div id="warmongerCount" style="color:#fff;">0 Attacks</div>
            </div>
        </aside>

        <div class="map-wrapper" style="display:block; overflow-y:auto;">
            
            <div class="map-header">
                <span class="status-indicator">
                    <div class="status-dot" style="background:var(--neon-blue); box-shadow:0 0 8px var(--neon-blue);"></div> 
                    ARCHIVED DATA: <span id="archiveDate" style="color:#fff; margin-left:5px;">-</span>
                </span>
            </div>

            <div style="padding:20px;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-val" id="totalSpent">0</div>
                        <div class="stat-label">Coins Spent</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="totalAttacks">0</div>
                        <div class="stat-label">Attacks Launched</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="totalWars">0</div>
                        <div class="stat-label">Active Wars</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="favWeapon">-</div>
                        <div class="stat-label">Fav. Weapon</div>
                    </div>
                </div>

                <h3 style="color:var(--neon-blue); text-transform:uppercase; border-bottom:1px solid var(--border-color); padding-bottom:10px; margin-top:30px;">
                    Territory Snapshot
                </h3>
                
                <div id="mapSnapshot" class="snapshot-grid">
                    <div style="color:#aaa;">Select a date to load map state...</div>
                </div>
            </div>

        </div>

    </div>

    <div class="footer-text" style="text-align:center; padding: 10px; color: #555; font-size: 0.8rem;">
        CPA Archives System
    </div>

    <script>
        let historyData = [];
        let currentWeek = null;
        let currentTab = 'top10';

        window.onload = async function() {
            try {
                const response = await fetch('history.json');
                if (!response.ok) throw new Error("History file not found");
                historyData = await response.json();

                const selector = document.getElementById('weekSelector');
                selector.innerHTML = "";
                
                if (historyData.length === 0) {
                    selector.innerHTML = "<option>No Archives Found</option>";
                    return;
                }

                historyData.forEach((week, index) => {
                    const opt = document.createElement('option');
                    opt.value = index;
                    opt.innerText = `${week.id} (${week.date})`;
                    selector.appendChild(opt);
                });

                loadWeekData(0);

            } catch (e) {
                console.error(e);
                document.querySelector('.dashboard-container').innerHTML = 
                    `<div style="width:100%; text-align:center; padding-top:100px; color:#ff0055;">
                        <h2>ARCHIVE OFFLINE</h2>
                        <p>No history data generated yet.</p>
                    </div>`;
            }
        };

        function loadWeekData(index) {
            currentWeek = historyData[index];
            const stats = currentWeek.stats || {};
            
            // Header
            document.getElementById('archiveDate').innerText = currentWeek.date;

            // Preencher os Teus Stats Cards
            document.getElementById('totalSpent').innerText = formatMoney(stats.spent || 0);
            document.getElementById('totalAttacks').innerText = stats.attacks || 0;
            document.getElementById('totalWars').innerText = stats.wars || 0;
            document.getElementById('favWeapon').innerText = stats.fav_weapon || "None";

            // Warmonger (Preencher a tua sidebar)
            document.getElementById('warmongerName').innerText = stats.warmonger_name || "-";
            document.getElementById('warmongerCount').innerText = (stats.warmonger_count || 0) + " Attacks";

            // Renderizar Sidebar (Tabs)
            renderSidebar();

            // Renderizar Mapa (Snapshot)
            const mapContainer = document.getElementById('mapSnapshot');
            mapContainer.innerHTML = "";
            
            if (currentWeek.map_snapshot) {
                const sortedServers = Object.keys(currentWeek.map_snapshot).sort();
                sortedServers.forEach(serverName => {
                    const owner = currentWeek.map_snapshot[serverName];
                    let color = getArmyColor(owner);
                    
                    const dot = document.createElement('div');
                    dot.className = "snap-dot";
                    dot.style.backgroundColor = color;
                    dot.title = `${serverName}: ${owner}`;
                    mapContainer.appendChild(dot);
                });
            }
        }

        // L√≥gica das Tabs
        function switchTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderSidebar();
        }

        function renderSidebar() {
            const container = document.getElementById('leaderboardList');
            const title = document.getElementById('lbTitle');
            container.innerHTML = "";

            if (!currentWeek) return;

            let data = [];
            
            if (currentTab === 'top10') {
                title.innerText = "üèÜ Top 10 Armies";
                data = currentWeek.top_ten || [];
            } else if (currentTab === 'wealth') {
                title.innerText = "üí∞ Wealth Ranking";
                data = currentWeek.wealth || [];
            } else if (currentTab === 'active') {
                title.innerText = "‚öîÔ∏è Active Forces";
                data = currentWeek.active_forces || [];
            }

            if (data.length === 0) {
                container.innerHTML = "<div style='padding:10px; color:#666; text-align:center;'>No data available.</div>";
                return;
            }

            data.forEach((item, i) => {
                const row = document.createElement('div');
                row.className = "lb-row";
                
                let rankDisplay = i + 1;
                let valHtml = "";

                // Formata√ß√£o dependente da Tab
                if (currentTab === 'top10') {
                    rankDisplay = item.rank;
                    valHtml = `<span class="lb-val val-points">${item.points} PTS</span>`;
                } else if (currentTab === 'wealth') {
                    valHtml = `<span class="lb-val val-gold">$${formatMoney(item.balance)}</span>`;
                } else if (currentTab === 'active') {
                    valHtml = `<span class="lb-val" style="color:#fff;">${item.servers} Serv.</span>`;
                }

                row.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; flex:1;">
                        <span class="lb-rank">#${rankDisplay}</span>
                        <span class="lb-name">${item.name}</span>
                    </div>
                    ${valHtml}
                `;
                container.appendChild(row);
            });
        }

        // Helpers
        function formatMoney(amount) {
            if (!amount) return "0";
            if (amount >= 1000000) return (amount / 1000000).toFixed(1) + 'M';
            if (amount >= 1000) return (amount / 1000).toFixed(1) + 'k';
            return amount.toLocaleString('en-US');
        }

        function getArmyColor(name) {
            // Se tiveres cores fixas podes adicionar aqui, sen√£o gera autom√°tico
            if (name === "Freeland") return "#222";
            if (name === "None") return "#111";
            return stringToColor(name);
        }

        function stringToColor(str) {
            if (!str) return "#333";
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                let value = (hash >> (i * 8)) & 0xFF;
                color += ('00' + value.toString(16)).substr(-2);
            }
            return color;
        }
    </script>
</body>
</html>
