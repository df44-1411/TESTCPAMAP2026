<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CPA: THE ARCHIVE</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://code.highcharts.com/maps/highmaps.js"></script>
    
    <link rel="stylesheet" href="style.css"> 
    <link rel="stylesheet" href="map.css"> <style>
        body { background: #030a14; color: white; font-family: 'Rajdhani', sans-serif; margin: 0; overflow: hidden; }
        
        .dashboard-container { display: flex; height: calc(100vh - 60px); }

        /* SIDEBAR DESIGN DO MAPA */
        .sidebar { 
            width: 380px; 
            background: rgba(5, 16, 32, 0.95); 
            border-right: 1px solid rgba(0, 243, 255, 0.2); 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            backdrop-filter: blur(10px);
        }

        /* DESIGN DOS CARTÕES (Fiel ao army_code.py) */
        .army-card {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(20, 30, 50, 0.85); border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 5px solid #555; margin-bottom: 10px; padding: 12px 15px;
            border-radius: 4px; backdrop-filter: blur(4px); transition: 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .army-card:hover { transform: translateX(5px); background: rgba(40, 50, 80, 0.95); }
        .army-name { color: #e0e6ed; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .army-count { background: rgba(0, 243, 255, 0.1); color: #00f3ff; padding: 2px 10px; border-radius: 10px; font-weight: bold; font-size: 0.9em; }

        /* ÁREA DO MAPA */
        .map-wrapper { flex: 1; position: relative; background: radial-gradient(circle, #0a192f 0%, #030a14 100%); }
        #container { width: 100%; height: 100%; }

        .tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid rgba(0, 243, 255, 0.1); padding-bottom: 10px; }
        .tab-btn { 
            flex: 1; padding: 10px; background: transparent; border: 1px solid rgba(0, 243, 255, 0.3); 
            color: #00f3ff; cursor: pointer; font-family: 'Rajdhani'; font-weight: bold; text-transform: uppercase;
        }
        .tab-btn.active { background: #00f3ff; color: #000; box-shadow: 0 0 15px rgba(0, 243, 255, 0.5); }

        .archive-selector {
            background: #051020; color: #00f3ff; border: 1px solid #00f3ff;
            padding: 12px; font-family: 'Rajdhani'; font-weight: bold; width: 100%; margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <nav class="top-nav" style="height: 60px; display: flex; align-items: center; padding: 0 30px; background: #051020; border-bottom: 1px solid #00f3ff;">
        <h1 style="margin: 0; font-size: 1.5em; letter-spacing: 2px;">CPA: THE ARCHIVE</h1>
        <div style="margin-left: auto;"><a href="index.html" style="color: #00f3ff; text-decoration: none; font-weight: bold;">LIVE MAP</a></div>
    </nav>

    <div class="dashboard-container">
        <aside class="sidebar">
            <select id="weekSelector" class="archive-selector" onchange="loadSnapshot(this.value)">
                <option>Loading records...</option>
            </select>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('topten', this)">Top 10</button>
                <button class="tab-btn" onclick="switchTab('forces', this)">Forces</button>
                <button class="tab-btn" onclick="switchTab('wealth', this)">Wealth</button>
            </div>

            <div id="leaderboardList" style="flex: 1; overflow-y: auto;"></div>
        </aside>

        <main class="map-wrapper">
            <div id="container"></div>
        </main>
    </div>

    <script>
        let historyData = [];
        let mapBase = []; // Onde guardaremos as paths do map.js
        let currentWeek = 0;
        let activeTab = 'topten';
        let chart;

        // Iniciar carregando a estrutura real do mapa
        async function init() {
            try {
                // 1. Carregar as coordenadas reais do map.js
                const mapResp = await fetch('map.js');
                const mapText = await mapResp.text();
                const mapMatch = mapText.match(/var mapData = (\[.*?\]);/s);
                mapBase = JSON.parse(mapMatch[1]);

                // 2. Carregar Histórico
                const histResp = await fetch('history.json?t=' + Date.now());
                historyData = await histResp.json();
                
                const selector = document.getElementById('weekSelector');
                selector.innerHTML = "";
                historyData.forEach((w, i) => {
                    selector.innerHTML += `<option value="${i}">${w.id.toUpperCase()} - ${w.date}</option>`;
                });

                loadSnapshot(0);
            } catch (e) {
                console.error("Erro na inicialização:", e);
            }
        }

        function loadSnapshot(index) {
            currentWeek = index;
            const data = historyData[index];
            
            // Renderizar Mapa via Highcharts com as cores do arquivo
            renderHighcharts(data.map_snapshot);
            renderLeaderboard();
        }

        function renderHighcharts(snapshot) {
            // Unir geometria base com os donos da semana
            const chartData = mapBase.map(region => ({
                ...region,
                controller: snapshot[region.name] || "None"
            }));

            if (chart) chart.destroy();

            chart = Highcharts.mapChart('container', {
                chart: { backgroundColor: 'transparent', type: 'map' },
                title: { text: '' },
                legend: { enabled: false },
                credits: { enabled: false },
                tooltip: {
                    backgroundColor: 'rgba(5, 16, 32, 0.9)',
                    style: { color: '#00f3ff', fontFamily: 'Rajdhani' },
                    formatter: function() { return `<b>${this.point.name}</b><br>Owner: ${this.point.controller}`; }
                },
                series: [{
                    data: chartData,
                    mapData: chartData,
                    joinBy: 'id',
                    dataLabels: {
                        enabled: true,
                        color: '#e0e6ed',
                        style: { textOutline: '1px black', fontFamily: 'Rajdhani', fontSize: '10px' },
                        format: '{point.name}'
                    },
                    point: {
                        events: {
                            click: function() { console.log(this.name + " owned by " + this.controller); }
                        }
                    }
                }]
            });
            
            // Aplicar classes CSS para as cores (Simulando o map.js)
            chart.series[0].points.forEach(p => {
                if(p.graphic) {
                    // Aqui você pode adicionar lógica de cores dinâmica baseada no map.css
                    p.graphic.element.setAttribute('fill', getArmyColor(p.controller));
                }
            });
        }

        function renderLeaderboard() {
            const week = historyData[currentWeek];
            const list = document.getElementById('leaderboardList');
            list.innerHTML = "";
            let items = [];

            if (activeTab === 'topten') {
                items = week.leaderboard.map((e, i) => ({ name: e.name, val: e.score + " PTS", rank: i+1 }));
            } else if (activeTab === 'forces') {
                const counts = {};
                Object.values(week.map_snapshot).forEach(o => {
                    if(o !== "None" && o !== "Freeland" && o !== "Locked Land") counts[o] = (counts[o] || 0) + 1;
                });
                items = Object.entries(counts).sort((a,b) => b[1] - a[1]).map(([n,v], i) => ({ name: n, val: v + " SVRS", rank: i+1 }));
            } else if (activeTab === 'wealth') {
                items = Object.entries(week.wealth_snapshot || {}).sort((a,b) => b[1] - a[1]).map(([n,v], i) => ({ name: n, val: "$" + v.toLocaleString(), rank: i+1 }));
            }

            items.forEach(item => {
                list.innerHTML += `
                    <div class="army-card" style="border-left-color: ${getArmyColor(item.name)}">
                        <span class="army-name">#${item.rank} ${item.name}</span>
                        <span class="army-count">${item.val}</span>
                    </div>`;
            });
        }

        function switchTab(tab, btn) {
            activeTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderLeaderboard();
        }

        function getArmyColor(name) {
            // Mapeamento de cores baseado no teu wealth_generator.py
            const colors = {
                "Army of Club Penguin": "#2b8b1f",
                "Rebel Penguin Federation": "#060505",
                "Templars": "#f1c40f",
                "Water Vikings": "#043acf",
                "Help Force": "#000dff",
                "Blue Team": "#0074ad",
                "Red Team": "#e00007",
                "Green Team": "#02990e",
                "Black Team": "#202024",
                "Locked Land": "#051020",
                "Freeland": "#666666"
            };
            return colors[name] || "#555";
        }

        function formatMoney(n) { return n >= 1000000 ? (n/1000000).toFixed(1) + 'M' : n >= 1000 ? (n/1000).toFixed(1) + 'k' : n; }

        init();
    </script>
</body>
</html>
